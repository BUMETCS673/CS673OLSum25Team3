{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset Password | MyMedic</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
  <link rel="stylesheet" href="{% static 'css/login.css' %}">
</head>
<body>
  <div class="auth-box animate__animated animate__fadeIn">
    <div class="text-center mb-4">
      <h1 class="display-6 fw-bold" style="color: #20b2aa;">MyMedic</h1>
      <p class="lead text-muted"><b>Create new password</b></p>
    </div>
    <div id="reset-form">
      <p class="text-muted mb-4">Enter your new password below.</p>
      <input type="password" id="new-pass" class="form-control" placeholder="New Password">
      <input type="password" id="confirm-pass" class="form-control" placeholder="Confirm Password">
      <button onclick="resetPassword()" class="btn btn-success w-100 mt-3">Reset Password</button>
    </div>
    <div class="text-center mt-3">
      <a href="/login/">Back to <b>Login</b></a>
    </div>
    <p id="reset-msg" class="mt-3 text-center"></p>
  </div>

  <script>
    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    // Validate token on page load
    async function validateToken() {
      if (!token) {
        document.getElementById('reset-form').innerHTML = '<p class="text-danger">Invalid or missing token.</p>';
        return;
      }

      try {
        const res = await fetch("/api/validate-reset-token/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: token })
        });

        const data = await res.json();
        
        if (!res.ok) {
          document.getElementById('reset-form').innerHTML = '<p class="text-danger">This reset link is invalid or has expired.</p>';
        }
      } catch (error) {
        document.getElementById('reset-form').innerHTML = '<p class="text-danger">Error validating token. Please try again.</p>';
      }
    }

    async function resetPassword() {
      const resetButton = document.querySelector('button');
      const messageElement = document.getElementById("reset-msg");
      const newPassword = document.getElementById("new-pass").value;
      const confirmPassword = document.getElementById("confirm-pass").value;

      // Clear previous messages
      messageElement.innerText = "";
      messageElement.className = "";

      // Validation
      if (!newPassword || !confirmPassword) {
        messageElement.innerText = "Please fill in all fields.";
        messageElement.className = "text-danger mt-3 text-center";
        return;
      }

      if (newPassword.length < 6) {
        messageElement.innerText = "Password must be at least 6 characters long.";
        messageElement.className = "text-danger mt-3 text-center";
        return;
      }

      if (newPassword !== confirmPassword) {
        messageElement.innerText = "Passwords do not match.";
        messageElement.className = "text-danger mt-3 text-center";
        return;
      }

      const originalText = resetButton.innerText;
      resetButton.disabled = true;
      resetButton.innerText = "Resetting...";

      try {
        const res = await fetch("/api/reset-password/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            token: token,
            new_password: newPassword
          })
        });

        const data = await res.json();
        
        if (res.ok) {
          messageElement.innerText = "Password reset successfully! Redirecting to login...";
          messageElement.className = "text-success mt-3 text-center";
          document.getElementById('reset-form').style.display = 'none';
          setTimeout(() => {
            window.location.href = "/login/";
          }, 2000);
        } else {
          messageElement.innerText = data.error || "Failed to reset password. Please try again.";
          messageElement.className = "text-danger mt-3 text-center";
        }
      } catch (error) {
        messageElement.innerText = "Network error. Please check your connection.";
        messageElement.className = "text-danger mt-3 text-center";
      } finally {
        resetButton.disabled = false;
        resetButton.innerText = originalText;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      validateToken();
      
      document.getElementById("confirm-pass").addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          resetPassword();
        }
      });
    });
  </script>
</body>
</html>